{"version":3,"sources":["../../../../../../assets/hall/script/public/assets/hall/script/public/voiceQueueMgr.js"],"names":["QueueMgr","voiceList","playVoiceTime","isRecord","init","voiceBtn","fun","event","add","playerVoiceChat","bind","close","remove","update","dt","nextVoice","data","chatType","cc","sys","isNative","push","length","voiceEnd","voiceData","shift","dispatch","PhoneVoice","require","pauseAll","playAudio","content","resumeAll","startRecord","endRecord","isCanRecord","module","exports","new"],"mappings":";;;;;;AAAA;;;;;;;AAOA,IAAIA,WAAW,SAAXA,QAAW,GAAU;AACrB,SAAKC,SAAL,GAAiB,EAAjB;AACA,SAAKC,aAAL,GAAqB,CAAC,CAAtB;AACA,SAAKC,QAAL,GAAmB,KAAnB;AACA,SAAKC,IAAL,GAAY,UAASC,QAAT,EAAkB;AAC1BC,YAAIC,KAAJ,CAAUC,GAAV,CAAc,aAAd,EAA6B,UAA7B,EAAyC,KAAKC,eAAL,CAAqBC,IAArB,CAA0B,IAA1B,CAAzC;AACH,KAFD;AAGA,SAAKC,KAAL,GAAa,YAAU;AACnBL,YAAIC,KAAJ,CAAUK,MAAV,CAAiB,aAAjB,EAAgC,UAAhC,EAA4C,KAAKH,eAAL,CAAqBC,IAArB,CAA0B,IAA1B,CAA5C;AACH,KAFD;AAGA,SAAKG,MAAL,GAAc,UAASC,EAAT,EAAY;AACtB,YAAG,KAAKZ,aAAL,IAAsB,CAAC,CAA1B,EAA4B;AACxB,iBAAKA,aAAL,IAAsBY,EAAtB;AACA,gBAAG,KAAKZ,aAAL,GAAqB,CAAxB,EAA0B;AACtB,qBAAKA,aAAL,GAAqB,CAAC,CAAtB;AACA,qBAAKa,SAAL;AACH;AACJ;AAEJ,KATD;;AAWA,SAAKN,eAAL,GAAuB,UAASO,IAAT,EAAc;AACjC,YAAGA,KAAKC,QAAL,IAAiB,OAApB,EAA4B;AAAC;AAAO;AACpC;AACA,YAAG,CAACC,GAAGC,GAAH,CAAOC,QAAX,EAAsB;AAAC;AAAO;AAC9B,aAAKnB,SAAL,CAAeoB,IAAf,CAAoBL,IAApB;AACA,aAAKD,SAAL;AACH,KAND;;AAQA,SAAKA,SAAL,GAAiB,YAAU;AACvB,YAAG,KAAKd,SAAL,CAAeqB,MAAf,GAAwB,CAA3B,EAA6B;AACzB,iBAAKC,QAAL;AACA;AACH;AACD;AACA,YAAG,KAAKrB,aAAL,IAAsB,CAAC,CAA1B,EAA4B;AAAC;AAAO;AACpC;AACA;AACA,YAAG,KAAKC,QAAR,EAAiB;AAAC;AAAO;;AAEzB,YAAIqB,YAAiB,KAAKvB,SAAL,CAAewB,KAAf,EAArB;AACAD,kBAAUF,MAAV,GAAqBE,UAAUF,MAAV,GAAiB,IAAtC;AACA,aAAKpB,aAAL,GAAqBsB,UAAUF,MAA/B;;AAEAhB,YAAIC,KAAJ,CAAUmB,QAAV,CAAmB,eAAnB,EAAoCF,SAApC;AACA,YAAIG,aAAiBC,QAAQ,cAAR,CAArB;AACAA,gBAAQ,OAAR,EAAiBC,QAAjB;AACAF,mBAAWG,SAAX,CAAqBN,UAAUO,OAA/B;AACH,KAnBD;;AAsBA,SAAKR,QAAL,GAAgB,YAAU;AACtBK,gBAAQ,OAAR,EAAiBI,SAAjB;AACH,KAFD;;AAIA,SAAKC,WAAL,GAAmB,YAAU;AACzB,aAAK9B,QAAL,GAAgB,IAAhB;AACH,KAFD;;AAIA,SAAK+B,SAAL,GAAkB,YAAU;AACxB,aAAK/B,QAAL,GAAgB,KAAhB;AACA,aAAKY,SAAL;AACH,KAHD;;AAKA,SAAKoB,WAAL,GAAmB,YAAU;AACzB,eAAQ,KAAKjC,aAAL,IAAsB,CAAC,CAA/B;AACH,KAFD;AAOH,CAvED;;AA2EAkC,OAAOC,OAAP,GAAiB;AACbC,SAAM,gBAAU;AACZ,eAAO,IAAItC,QAAJ,EAAP;AACH;AAHY,CAAjB","file":"voiceQueueMgr.js","sourceRoot":"../../../../../../assets/hall/script/public","sourcesContent":["/*\n    此队列机制是因为目前项目引用的录音工具库有bug，在此前的黄岩麻将上国良哥决定的这套机制\n    1、语音一条一条的播放\n    2、正在播放语音不录音\n    3、正在录音不播放语音\n*/\n\nlet QueueMgr = function(){\n    this.voiceList = [];\n    this.playVoiceTime = -1;\n    this.isRecord    = false;\n    this.init = function(voiceBtn){\n        fun.event.add(\"publicVoice\", \"RoomChat\", this.playerVoiceChat.bind(this))\n    }\n    this.close = function(){\n        fun.event.remove(\"publicVoice\", \"RoomChat\", this.playerVoiceChat.bind(this))\n    }\n    this.update = function(dt){\n        if(this.playVoiceTime != -1){\n            this.playVoiceTime -= dt;\n            if(this.playVoiceTime < 0){\n                this.playVoiceTime = -1;\n                this.nextVoice();\n            }\n        }\n\n    }\n\n    this.playerVoiceChat = function(data){\n        if(data.chatType != \"voice\"){return}\n        //浏览器不播放语音\n        if(!cc.sys.isNative ) {return} \n        this.voiceList.push(data);\n        this.nextVoice()\n    }\n    \n    this.nextVoice = function(){\n        if(this.voiceList.length < 1){\n            this.voiceEnd();\n            return\n        }\n        //正在播放语音，暂时不播放，一条一条的播放\n        if(this.playVoiceTime != -1){return}\n        //因为边播放语音边录音这个三方工具包有录音没有声音的bug\n        //所以正在录音, 不播放。\n        if(this.isRecord){return}\n        \n        var voiceData      = this.voiceList.shift();\n        voiceData.length   = voiceData.length/1000\n        this.playVoiceTime = voiceData.length;\n\n        fun.event.dispatch('RoomChatVoice', voiceData);\n        let PhoneVoice     = require(\"JSPhoneVoice\");\n        require(\"Audio\").pauseAll();\n        PhoneVoice.playAudio(voiceData.content)\n    }\n    \n\n    this.voiceEnd = function(){\n        require(\"Audio\").resumeAll();\n    }\n\n    this.startRecord = function(){\n        this.isRecord = true;\n    }\n\n    this.endRecord  = function(){\n        this.isRecord = false;\n        this.nextVoice();\n    }\n\n    this.isCanRecord = function(){\n        return (this.playVoiceTime == -1);\n    }\n\n\n\n\n}\n\n\n\nmodule.exports = {\n    new : function(){\n        return new QueueMgr();\n    }\n}"]}