{"version":3,"sources":["../../../../../../assets/hall/script/login/assets/hall/script/login/login.js"],"names":["cc","Class","extends","Component","properties","gameName","type","gameConst","default","hall","onLoad","sys","isNative","console","log","jsb","fileUtils","getWritablePath","JSPhoneVoice","require","clearOldVoice","getBaiDuLocation","_isApple","fun","gameCfg","releaseType","apple","editBox","node","getChildByName","active","wxLoginBtn","ykLoginBtn","isIDLogin","loginType","ID","getComponent","Label","string","director","preloadScene","enableUpdate","db","getData","event","add","onCompleteUpdateEvent","bind","initLogin","version","onDestroy","remove","isWxAppInstalled","install","setPositionX","token","localStorage","getItem","enableAutoLogin","net","connect","loginUrl","pSend","Token","Platform","os","loginHandle","OS_ANDROID","WxAppIsInstalled","on","onLoginBtnClick","onGuestBtnClick","data","k","playEffect","weChatLogin","weChat","guestLogin","guest","idLogin","WxLogin","msg","state","wxLogin","Thirdparty","OpenId","openid","AccessToken","_isConnected","UserId","id","EditBox","length","parseInt","RetCode","func","once","dispatch","okCb","contentStr","closeCb","removeItem","utils","restart","setState","userInfo","location","undefined","setData","setItem","loadScene"],"mappings":"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","file":"login.js","sourceRoot":"../../../../../../assets/hall/script/login","sourcesContent":["﻿cc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        gameName: {\r\n            type: gameConst.gameName,\r\n            default: gameConst.gameName.hall,\r\n        },\r\n    },\r\n\r\n    onLoad () {\r\n        if (cc.sys.isNative) {\r\n            console.log('WritablePath = ' + jsb.fileUtils.getWritablePath());\r\n            let JSPhoneVoice = require('JSPhoneVoice');\r\n            JSPhoneVoice.clearOldVoice();\r\n            require('JSPhoneBaiDu').getBaiDuLocation();\r\n        }\r\n\r\n        // let isRelease = fun.gameCfg.releaseType === gameConst.releaseType.release ? true : false;\r\n        this._isApple = fun.gameCfg.releaseType === gameConst.releaseType.apple ? true : false;\r\n\r\n        this.editBox = this.node.getChildByName('editBox');\r\n        this.editBox.active = false;\r\n        this.wxLoginBtn = this.node.getChildByName('btnWxLogin');\r\n        this.ykLoginBtn = this.node.getChildByName('btnYkLogin');\r\n        \r\n        let isIDLogin = fun.gameCfg.loginType === gameConst.loginType.ID;\r\n        this.ykLoginBtn.getChildByName('Label').getComponent(cc.Label).string = isIDLogin ? '账号登陆' : '游客登陆';\r\n        cc.director.preloadScene(\"hall\", function () {});\r\n\r\n        if (cc.sys.isNative && fun.gameCfg.enableUpdate && !fun.db.getData('UpdatedGame')[this.gameName]) {\r\n            this.wxLoginBtn.active = false;\r\n            this.ykLoginBtn.active = false;\r\n            fun.event.add('hallUpdatedGame', 'UpdatedGame', this.onCompleteUpdateEvent.bind(this));\r\n        } else {\r\n            this.initLogin();\r\n        }\r\n        this.node.getChildByName('version').getComponent(cc.Label).string = gameConst.version;\r\n    },\r\n\r\n    onDestroy () {\r\n        fun.event.remove('hallUpdatedGame');\r\n    },\r\n\r\n    isWxAppInstalled (install) {\r\n        if(!install && this._isApple){\r\n            this.wxLoginBtn.active = false;\r\n            this.ykLoginBtn.setPositionX(0);\r\n            this.ykLoginBtn.active = true;\r\n        } else {\r\n            this.wxLoginBtn.active = true;\r\n            this.ykLoginBtn.active = true;\r\n        }\r\n    },\r\n\r\n    initLogin() {\r\n        let token = cc.sys.localStorage.getItem('Token');\r\n        if (token && fun.gameCfg.enableAutoLogin) {\r\n            fun.net.connect(fun.gameCfg.loginUrl, function () {\r\n                fun.net.pSend('TokenLogin', {Token: token, Platform: cc.sys.os}, this.loginHandle.bind(this));\r\n            }.bind(this))\r\n        } else {\r\n            if (cc.sys.os === cc.sys.OS_ANDROID) {\r\n                this.wxLoginBtn.active = true;\r\n                this.wxLoginBtn.setPositionX(0);\r\n                this.ykLoginBtn.active = false;\r\n            } else {\r\n                this.isWxAppInstalled(require('JSPhoneWeChat').WxAppIsInstalled());\r\n            }\r\n            if (fun.gameCfg.loginType === gameConst.loginType.ID) {\r\n                this.editBox.active = true;\r\n            }\r\n            this.wxLoginBtn.on('click', this.onLoginBtnClick, this);\r\n            this.ykLoginBtn.on('click', this.onGuestBtnClick, this);\r\n        }\r\n    },\r\n\r\n    onCompleteUpdateEvent (data) {\r\n        for (const k in data) {\r\n            if (data[k] === this.gameName) {\r\n                this.initLogin();\r\n                break;\r\n            }\r\n        }\r\n    },\r\n\r\n    onLoginBtnClick (event) {\r\n        require('Audio').playEffect('hall', 'button_nomal.mp3');\r\n        fun.net.connect(fun.gameCfg.loginUrl, function () {\r\n            this.weChatLogin();\r\n        }.bind(this));\r\n    },\r\n\r\n    onGuestBtnClick(){\r\n        fun.net.connect(fun.gameCfg.loginUrl, function () {\r\n            switch (fun.gameCfg.loginType) {\r\n                case gameConst.loginType.weChat:\r\n                    this.guestLogin();\r\n                case gameConst.loginType.guest:\r\n                    this.guestLogin();\r\n                    break;\r\n                case gameConst.loginType.ID:\r\n                    this.idLogin();\r\n                    break;\r\n            }\r\n        }.bind(this));\r\n    },\r\n\r\n    weChatLogin () {\r\n        fun.log('login', 'weChatLogin');\r\n        require('JSPhoneWeChat').WxLogin(function(msg){\r\n            if (msg.state) {\r\n                let wxLogin = {Thirdparty: 1, OpenId: msg.openid, AccessToken: msg.token, Platform: cc.sys.os};\r\n                if (fun.net._isConnected()) {\r\n                    fun.net.pSend('ThirdLogin', wxLogin, this.loginHandle.bind(this));\r\n                } else {\r\n                    fun.net.connect(fun.gameCfg.loginUrl, function() {\r\n                        fun.net.pSend('ThirdLogin', wxLogin, this.loginHandle.bind(this));\r\n                    }.bind(this));\r\n                }\r\n            }\r\n        }.bind(this));\r\n    },\r\n\r\n    guestLogin () {\r\n        fun.log('login', 'guestLogin');\r\n        fun.net.pSend('GustLogin', {UserId: 0}, this.loginHandle);\r\n    },\r\n\r\n    idLogin () {\r\n        fun.log('login', 'idLogin');\r\n        let id = this.editBox.getComponent(cc.EditBox).string;\r\n        if (id.length !== 6) {\r\n            fun.log('login', `error id ${id}`);\r\n            return;\r\n        }\r\n        fun.net.pSend('GustLogin', {UserId: parseInt(id)}, this.loginHandle);\r\n    },\r\n\r\n    loginHandle (data) {\r\n        if (data.RetCode && data.RetCode !== 0) {\r\n            fun.log('login', 'login error: ', data);\r\n            switch(data.RetCode){\r\n                case 1: {\r\n                        let func = function(){\r\n                            this.wxLoginBtn.once('click', this.onLoginBtnClick, this);\r\n                        }.bind(this)\r\n                        fun.event.dispatch('MinSingleButtonPop', {okCb: func, contentStr: '服务器忙', closeCb: func});\r\n                    }\r\n                    break;\r\n                case 2:\r\n                    fun.event.dispatch('MinSingleButtonPop', {contentStr: '非法游戏类型'});\r\n                    break;\r\n                case 3:\r\n                    fun.event.dispatch('MinSingleButtonPop', {contentStr: '登录失败'});\r\n                    break;\r\n                case 4: {\r\n                        cc.sys.localStorage.removeItem('Token');\r\n                        fun.utils.restart();\r\n                    }\r\n                    break;\r\n                case 5:\r\n                    fun.event.dispatch('MinSingleButtonPop', {contentStr: '非法第三方平台'});\r\n                    break;\r\n                default:\r\n                    break;\r\n            }\r\n            return;\r\n        }\r\n        fun.net.setState('Login');\r\n        let userInfo = fun.db.getData('UserInfo');\r\n        if (userInfo.location !== undefined) {\r\n            data.location = userInfo.location;\r\n        } else {\r\n            data.location = null;\r\n        }\r\n        fun.db.setData('UserInfo', data);\r\n        cc.sys.localStorage.setItem('Token', data.Token);\r\n        cc.director.loadScene('hall');\r\n    },\r\n});\r\n"]}