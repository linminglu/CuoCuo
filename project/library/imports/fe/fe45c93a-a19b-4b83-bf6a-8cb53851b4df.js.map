{"version":3,"sources":["../../../../../../assets/hall/script/mailLayer/assets/hall/script/mailLayer/mailLayer.js"],"names":["Audio","require","cc","Class","extends","Component","properties","itemTemplate","default","type","Node","scrollView","ScrollView","spacing","mailDetailPre","Prefab","init","reqCount","mailInfo","content","totalCount","bg","node","getChildByName","length","sys","localStorage","setItem","mId","active","addItems","forEach","value","item","instantiate","parent","lId","time","Date","timeStr","getFullYear","getMonth","getDate","getComponent","updateItem","y","height","on","onItemClick","bind","once","onBottomCb","onEnable","Animation","play","fun","net","pSend","Page","Count","rsp","mInfos","index","data","playEffect","callback","children","lid","destroy","mailDetail","mType","onBtnCloseClick","animState"],"mappings":"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","file":"mailLayer.js","sourceRoot":"../../../../../../assets/hall/script/mailLayer","sourcesContent":["let Audio = require('Audio');\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        itemTemplate: {\n            default: null,\n            type: cc.Node,\n        },\n\n        scrollView: {\n            default: null,\n            type: cc.ScrollView,\n        },\n\n        spacing: {\n            default: 0,\n        },\n\n        mailDetailPre: {\n            type: cc.Prefab,\n            default: null,\n        },\n    },\n\n    init(reqCount, mailInfo) {\n        if (!mailInfo) {\n            mailInfo = [];\n        }\n        this.content = this.scrollView.content;\n        this.totalCount = 0;\n        this.reqCount = reqCount;\n        let bg = this.node.getChildByName('back');\n        // bg.getChildByName('btnClose').on('click', this.onBtnCloseClick, this);\n        if (mailInfo.length > 0) {\n            cc.sys.localStorage.setItem('LastMailID', mailInfo[0].mId);\n            bg.getChildByName('noEmail').active = false;\n            this.scrollView.active = true;\n            this.addItems(mailInfo);\n        } else {\n            // this.scrollView.node.active = false;\n            bg.getChildByName('noEmail').active = true;\n        }\n\n    },\n\n    addItems(mailInfo) {\n        mailInfo.forEach(function (value) {\n            let item = cc.instantiate(this.itemTemplate);\n            item.parent = this.content;\n            item.active = true;\n            value.lId = this.totalCount;\n            let time = new Date(value.time * 1000);\n            value.timeStr = `${time.getFullYear()}年${time.getMonth()+1}月${time.getDate()}日`;\n            item.getComponent('mailItem').updateItem(value);\n            item.y = -item.height * (0.5 + this.totalCount) - this.spacing * this.totalCount;\n            item.on('click', this.onItemClick.bind(this, this.totalCount, value));\n            this.totalCount++;\n        }, this);\n        this.content.height = this.totalCount*(this.itemTemplate.height+this.spacing)+this.spacing;\n        if (this.reqCount === mailInfo.length) {\n            this.scrollView.node.once('scroll-to-bottom', this.onBottomCb, this);\n        }\n    },\n\n    onEnable() {\n        this.node.getComponent(cc.Animation).play('popScaleAnim');\n    },\n\n    onBottomCb() {\n        fun.net.pSend('MailList', {Page: this.totalCount+1, Count: this.reqCount}, function (rsp) {\n            if (rsp.mInfos && rsp.mInfos.length > 0) {\n                this.addItems(rsp.mInfos);\n            }\n        }.bind(this));\n    },\n\n    onItemClick(index, data) {\n        Audio.playEffect('hall', 'button_nomal.mp3');\n        let callback = function(){\n            fun.net.pSend('DelMail', {mId: data.mId}, function (rsp) {\n                this.content.children.forEach(function (item) {\n                    const lid = item.getComponent('mailItem').lId;\n                    if (lid > index) {\n                        item.y += (item.height + this.spacing);\n                    } else if (lid === index) {\n                        item.destroy();\n                    }\n                }, this);\n            }.bind(this));\n        }.bind(this);\n        data.callback = callback;\n        let mailDetail = cc.instantiate(this.mailDetailPre);\n        mailDetail.getComponent('mailDetail').init(data);\n        mailDetail.parent = this.node;\n        if (data.mType === 1) {\n            callback();\n        }\n    },\n\n    onBtnCloseClick() {\n        Audio.playEffect('hall', 'button_close.mp3');\n        this.animState = this.node.getComponent(cc.Animation).play('popScaleOut');\n        this.animState.once('finished', function () {\n            this.node.destroy();\n        }.bind(this));\n    },\n});\n"]}