{"version":3,"sources":["../../../../../../assets/hall/script/public/assets/hall/script/public/publicVoiceBtn.js"],"names":["JSPhoneVoice","require","cc","Class","extends","Component","properties","voiceHintPre","type","Prefab","default","bgResN","Node","onLoad","node","on","EventType","TOUCH_START","onTouchBegan","TOUCH_MOVE","onTouchMoved","TOUCH_END","onTouchEnded","TOUCH_CANCEL","onTouchCancelled","mRect","getBoundingBox","pos","p","x","y","parent","convertToWorldSpaceAR","touching","userId","fun","db","getData","UserId","queueMgr","new","init","_showHide","color","Color","bind","_showNormal","onDestroy","close","startRecord","_startTime","Date","now","_voiceName","pauseAll","startAudio","stopRecord","_endTime","stopAudio","endRecord","sendRecord","len","event","dispatch","contentStr","s","getVoiceDataByName","net","pSend","chatType","content","length","from","isCanRecord","voiceHint","instantiate","director","getScene","getChildByName","voiceHintCtr","getComponent","showMove","sumTime","getTouches","getLocation","rectContainsPoint","showPress","destroy","checkHide","data","update","dt","setVoiceTime"],"mappings":"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","file":"publicVoiceBtn.js","sourceRoot":"../../../../../../assets/hall/script/public","sourcesContent":["let JSPhoneVoice = require('JSPhoneVoice');\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        voiceHintPre: {\n            type: cc.Prefab,\n            default: null,\n        },\n        bgResN : cc.Node,\n\n    },\n\n    onLoad () {\n        this.node.on(cc.Node.EventType.TOUCH_START, this.onTouchBegan, this);\n        this.node.on(cc.Node.EventType.TOUCH_MOVE, this.onTouchMoved, this);\n        this.node.on(cc.Node.EventType.TOUCH_END, this.onTouchEnded, this);\n        this.node.on(cc.Node.EventType.TOUCH_CANCEL, this.onTouchCancelled, this);\n\n        this.mRect = this.node.getBoundingBox();\n        let pos = cc.p(this.mRect.x, this.mRect.y);\n        pos = this.node.parent.convertToWorldSpaceAR(pos);\n        this.mRect.x = pos.x;\n        this.mRect.y = pos.y;\n        this.touching = false;\n\n        this.userId = fun.db.getData('UserInfo').UserId;\n        this.queueMgr = require(\"voiceQueueMgr\").new();\n        this.queueMgr.init();\n        if(this.bgResN){\n            this.bgResN._showHide = function(){\n                this.bgResN.color = new cc.Color(255, 255, 255)\n            }.bind(this)\n            this.bgResN._showNormal = function(){\n                this.bgResN.color = new cc.Color(100, 100, 100);\n            }.bind(this)\n            this.bgResN._showNormal();\n        }\n    },\n\n\n    onDestroy(){\n        this.queueMgr.close();\n    },\n\n\n    startRecord() {\n        this._startTime = Date.now();\n        this._voiceName = 'voice' + this._startTime;\n        require(\"Audio\").pauseAll();\n        JSPhoneVoice.startAudio(this._voiceName);\n        this.queueMgr.startRecord();\n    },\n\n    stopRecord() {\n        this._endTime = Date.now();\n        JSPhoneVoice.stopAudio();\n        this.queueMgr.endRecord();\n    },\n\n    sendRecord() {\n\n        let len = this._endTime - this._startTime;\n        if (len < 1000) {\n            fun.event.dispatch('MinSingleButtonPop', {contentStr: '录音时间过短,请重新录制!'});\n            return;\n        }\n        const s = JSPhoneVoice.getVoiceDataByName(this._voiceName);\n        if (!s) {\n            fun.event.dispatch('MinSingleButtonPop', {contentStr: '录音失败!'});\n        } else {\n            fun.net.pSend('Chat', {chatType: 'voice', content: s, length: len, from: this.userId});\n        }\n    },\n\n    onTouchBegan (event) {\n        if(!this.queueMgr.isCanRecord()){\n            //可给用户添加点提示\n            return\n        }\n        this.voiceHint = cc.instantiate(this.voiceHintPre);\n        this.voiceHint.parent = cc.director.getScene().getChildByName('Canvas');\n        this.voiceHintCtr = this.voiceHint.getComponent('voiceHint');\n        this.voiceHintCtr.showMove();\n        this.sumTime = 0;\n        this.touching = true;\n        this.startRecord();\n    },\n\n    onTouchMoved (event) {\n        if(!this.touching){return}\n        let pos = event.getTouches()[0].getLocation();\n        if (cc.rectContainsPoint(this.mRect, pos)) {\n            this.voiceHintCtr.showMove();\n        } else {\n            this.voiceHintCtr.showPress();\n        }\n    },\n\n    onTouchEnded (event) {\n        if(!this.touching){return}\n        this.touching = false;\n        this.voiceHint.destroy();\n        this.stopRecord();\n        this.sendRecord();\n    },\n\n    onTouchCancelled (event) {\n        this.touching = false;\n        this.voiceHint.destroy();\n        this.stopRecord();\n    },\n\n    checkHide(data){\n        if(!this.bgResN){return}\n        if(this.queueMgr.isCanRecord()){\n            this.bgResN._showNormal();\n        }{\n            this.bgResN._showHide();\n        }\n    },\n\n    update (dt) {\n        this.checkHide()\n        this.queueMgr.update(dt);\n        if (!this.touching) {\n            return;\n        }\n\n        this.sumTime += dt;\n        if (!this.voiceHintCtr.setVoiceTime(this.sumTime)) {\n            this.onTouchEnded();\n        }\n    },\n\n\n});\n"]}