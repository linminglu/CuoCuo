{"version":3,"sources":["../../../../../../assets/hall/script/public/assets/hall/script/public/store.js"],"names":["Audio","require","ApplePayResult","cc","Enum","Class","extends","Component","properties","titleLabel","type","Label","default","onLoad","animation","node","getComponent","Animation","clips","getClips","_isApple","sys","os","OS_IOS","setGameType","gameConst","gameType","maJiangHuangYan","fun","event","add","onPhonePayResultAck","bind","start","csv","turnCsvToJson","csvJson","data","Array","i","utils","getLength","_gameType","parseInt","INT_Game","length","_csvJson","initShopList","onDestroy","remove","string","gameTypeZhNameMap","bg","getChildByName","shopList","childrenCount","box","price","roomCard","songKa","songKaBg","INT_Price","INT_OpValue","INT_GiveValue","active","btnShop","on","onBtnShopClick","onBtnCloseClick","num","playEffect","isNative","dispatch","flag","text","_roomCardNum","ApplePay","STR_ID","net","pSend","GameType","Product","INT_Index","RetCode","WxPay","msg","from","result","ReceiptStr","receipt","setTimeout","Status","SUCCESS","localStorage","setItem","JSON","stringify","check","onEnable","play","name","once","destroy"],"mappings":"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","file":"store.js","sourceRoot":"../../../../../../assets/hall/script/public","sourcesContent":["let Audio = require('Audio');\nconst ApplePayResult = cc.Enum({\n    'OTHER': 0,\n    'SUCCESS': 1,\n    'FAILED': 2,\n    'PRODUCT_NOT_EXIST': 3,\n    'SUCCESSED': 4,\n});\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        titleLabel: {\n            type: cc.Label,\n            default: null,\n        },\n    },\n\n    onLoad () {\n        this.animation = this.node.getComponent(cc.Animation);\n        this.clips = this.animation.getClips();\n\n        this._isApple = cc.sys.os === cc.sys.OS_IOS ? true : false;\n        this.setGameType(gameConst.gameType.maJiangHuangYan);\n        fun.event.add('Store_PayResult', 'PhonePayResult', this.onPhonePayResultAck.bind(this));\n    },\n\n    start () {\n        fun.csv.turnCsvToJson('csv/shop.csv', function(csvJson){\n            let data = new Array();\n            for(let i=0; i<fun.utils.getLength(csvJson); ++i){\n                if(this._gameType === parseInt(csvJson[i+1].INT_Game)){\n                    data[data.length] = csvJson[i+1];\n                }\n            }\n            this._csvJson = data;\n            this.initShopList();\n        }.bind(this));\n    },\n\n    onDestroy: function () {\n        fun.event.remove('Store_PayResult');\n    },\n\n    setGameType(gameType) {\n        this._gameType = gameType;\n        this.titleLabel.string = gameConst.gameTypeZhNameMap[this._gameType];\n    },\n\n    initShopList(){\n        let bg = this.node.getChildByName('back');\n        let shopList = bg.getChildByName('shopList');\n        for (let i = 0; i < shopList.childrenCount; i++) {\n            let box = shopList.getChildByName(\"box\" + (i + 1));\n            let price, roomCard = box.getChildByName('num').getComponent(cc.Label);\n            let songKa = box.getChildByName('label'), songKaBg = box.getChildByName('bg');\n            price = '￥' + this._csvJson[i].INT_Price/100;\n            roomCard.string = this._csvJson[i].INT_OpValue + 'z';\n            if (this._csvJson[i].INT_GiveValue && parseInt(this._csvJson[i].INT_GiveValue)) {\n                songKa.getChildByName('num1').getComponent(cc.Label).string = this._csvJson[i].INT_GiveValue;\n            } else {\n                songKa.active = false;\n                songKaBg.active = false;\n            }\n            let btnShop = box.getChildByName('btnShop');\n            btnShop.getChildByName('label').getComponent(cc.Label).string = price;\n            btnShop.on('click', this.onBtnShopClick.bind(this, i));\n        }\n        bg.getChildByName('btnClose').on('click', this.onBtnCloseClick, this);\n    },\n\n    onBtnShopClick (num) {\n        Audio.playEffect('hall', 'button_nomal.mp3');\n        if (!cc.sys.isNative) return;\n        fun.event.dispatch('Zhuanquan', {flag: true, text: '支付中，请稍后...'});\n        this._roomCardNum = num;\n        if(this._isApple){\n            require('JSPhoneDevice').ApplePay(this._csvJson[num].STR_ID);\n        }else{\n            fun.net.pSend('WxPay', {GameType: this._gameType, Product: this._csvJson[num].INT_Index}, function(data){\n                if (data.RetCode && data.RetCode !== 0) return;\n                require('JSPhoneWeChat').WxPay(data);\n            }.bind(this));\n        }\n    },\n\n    onPhonePayResultAck (msg) {\n        fun.event.dispatch('Zhuanquan', {flag: false});\n        if (msg.from === 'apple') {\n            if (parseInt(msg.result) === 3) {\n                fun.net.pSend('ApPay', {ReceiptStr: msg.receipt}, function(data){\n                    if (data.RetCode && data.RetCode !== 0) {\n                        setTimeout(function(){\n                            this.onPhonePayResultAck(msg);\n                        }.bind(this), 2000);\n                    } else {\n                        if (data.Status && data.Status === ApplePayResult.SUCCESS) {\n                            cc.sys.localStorage.setItem('applePayReceiptStr', JSON.stringify({check: false}));\n                            fun.event.dispatch('HuangYanAddRoomCard', this._csvJson[this._roomCardNum].INT_OpValue);\n                        } else {\n                            setTimeout(function(){\n                                this.onPhonePayResultAck(msg);\n                            }.bind(this), 2000);\n                        }\n                    }\n                }.bind(this));\n            }\n        } else if (msg.from === 'wechat') {\n            if (msg.result && msg.result !== 'false')\n                fun.event.dispatch('HuangYanAddRoomCard', this._csvJson[this._roomCardNum].INT_OpValue);\n        }\n    },\n\n    onEnable () {\n        this.animation.play(this.clips[0].name);\n    },\n\n    onBtnCloseClick() {\n        Audio.playEffect('hall', 'button_close.mp3');\n        this.animation.play(this.clips[1].name).once('finished', function () {\n            this.node.destroy();\n        }, this);\n    }\n\n});\n"]}